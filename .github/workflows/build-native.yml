# GitHub Actions workflow for building native installers for pyopenms-viewer
# Builds on push of a tag, for Windows, macOS, and Linux

name: Build and Release Native Installers

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      WINDOWS_CERT_BASE64: ${{ secrets.WINDOWS_CERT_BASE64 }}
      WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
      APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
      APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_NOTARIZATION_APPLE_ID: ${{ secrets.APPLE_NOTARIZATION_APPLE_ID }}
      APPLE_NOTARIZATION_APP_PASSWORD: ${{ secrets.APPLE_NOTARIZATION_APP_PASSWORD }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-15]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -e ".[native]"
      - name: Build native app (Windows)
        if: runner.os == 'Windows'
        run: >-
          pyinstaller --noconfirm
          --additional-hooks-dir=. pyopenms-viewer-windows.spec
      - name: Build native app (macOS)
        if: runner.os == 'macOS'
        run: |
          python -m PyInstaller --noconfirm --additional-hooks-dir=. pyopenms-viewer.spec
          ls -lh dist/
      - name: Configure Windows code signing certificate
        if: runner.os == 'Windows' && env.WINDOWS_CERT_BASE64 != ''
        shell: pwsh
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
          [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String($env:WINDOWS_CERT_BASE64))
          $password = ConvertTo-SecureString -String $env:WINDOWS_CERT_PASSWORD -AsPlainText -Force
          $imported = Import-PfxCertificate -FilePath $certPath -Password $password -CertStoreLocation Cert:\CurrentUser\My
          if (-not $imported) { throw 'Failed to import Windows code signing certificate.' }
          $thumbprint = ($imported | Select-Object -First 1).Thumbprint
          "WINDOWS_CODESIGN_THUMBPRINT=$thumbprint" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Sign Windows executable
        if: runner.os == 'Windows' && env.WINDOWS_CODESIGN_THUMBPRINT != ''
        shell: pwsh
        run: |
          $signtool = (Get-ChildItem "$env:ProgramFiles(x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe | Sort-Object FullName -Descending | Select-Object -First 1).FullName
          if (-not $signtool) { $signtool = 'signtool.exe' }
          & $signtool sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /sha1 $env:WINDOWS_CODESIGN_THUMBPRINT dist/pyopenms-viewer.exe
      - name: Configure macOS signing keychain
        if: runner.os == 'macOS' && env.APPLE_CERT_BASE64 != ''
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          echo "$APPLE_CERT_BASE64" | base64 --decode > "$RUNNER_TEMP/apple_cert.p12"
          security import "$RUNNER_TEMP/apple_cert.p12" -k "$KEYCHAIN_PATH" -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | head -n 1 | awk '{print $2}')
          if [ -z "$IDENTITY" ]; then
            echo "No signing identity found" && exit 1
          fi
          echo "APPLE_CODESIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          echo "SIGNING_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
      - name: Sign macOS app bundle
        if: runner.os == 'macOS' && env.APPLE_CODESIGN_IDENTITY != ''
        env:
          SIGNING_KEYCHAIN: ${{ env.SIGNING_KEYCHAIN }}
        run: |
          security unlock-keychain -p actions "$SIGNING_KEYCHAIN"
          codesign --deep --force --options runtime --timestamp --sign "$APPLE_CODESIGN_IDENTITY" dist/pyopenms-viewer.app
      - name: Notarize macOS app (optional)
        if: runner.os == 'macOS' && env.APPLE_CODESIGN_IDENTITY != '' && env.APPLE_NOTARIZATION_APPLE_ID != '' && env.APPLE_NOTARIZATION_APP_PASSWORD != '' && env.APPLE_TEAM_ID != ''
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/pyopenms-viewer.app dist/pyopenms-viewer-macos.zip
          xcrun notarytool submit dist/pyopenms-viewer-macos.zip --apple-id "$APPLE_NOTARIZATION_APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_NOTARIZATION_APP_PASSWORD" --wait
          xcrun stapler staple dist/pyopenms-viewer.app
      - name: Package macOS app
        if: runner.os == 'macOS'
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/pyopenms-viewer.app dist/pyopenms-viewer-macos.zip
      - name: Build native app (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m PyInstaller --noconfirm --additional-hooks-dir=. pyopenms-viewer-linux.spec
          mv dist/pyopenms-viewer dist/pyopenms-viewer-linux
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyopenms-viewer-${{ matrix.os }}
          path: dist/
      - name: Verify macOS binary exists
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'macOS'
        run: |
          ls -lh dist/
          test -d dist/pyopenms-viewer.app && echo "✓ .app bundle found" || (echo "✗ .app bundle NOT found" && exit 1)
          test -f dist/pyopenms-viewer-macos.zip && echo "✓ Zipped bundle found" || (echo "✗ Zipped bundle NOT found" && exit 1)
      - name: Create GitHub Release (Windows)
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/pyopenms-viewer.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create GitHub Release (macOS)
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/pyopenms-viewer-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create GitHub Release (Linux)
        if: startsWith(github.ref, 'refs/tags/') && runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/pyopenms-viewer-linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
